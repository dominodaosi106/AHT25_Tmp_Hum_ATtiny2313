# AHT25_Tmp_Hum_ATtiny2313

ATtiny2313Aを使用した温度湿度計です。  
温度湿度センサーとしてAHT25を使用し、温度と湿度を測定して7セグメントLEDで表示します。  

現在の設定では、温度と湿度を約330ms間隔（250msタイマー＋80msセンサー待機）で取得し、7セグメントLEDでリアルタイムに表示します。  
スイッチ（PD6に接続）を短く押すたびに、最高値（1秒表示）→最低値（1秒表示）→通常表示の順に切り替わります。  
さらに、スイッチを約4秒以上長押しすると、最高値と最低値がリセットされ、リセット確認として「8.8.8.8.8.8.」が1秒間表示されます。

---

## 概要

ATtiny2313を大量に在庫しているため、これを活用するプロジェクトとして温度湿度計を製作しました。  
製作のきっかけはコロナ禍で室内環境を管理する必要性を感じたことで、温度と湿度を簡単に確認できるデバイスを目指しました。  
表示には視認性の良い7セグメントLEDを採用し、配線を簡略化することを重視しました。

### ピンの割り当て

配線とプログラムをシンプルにするため、以下のようにピンを割り当てました：

- **PD0～PD5**: 7セグメントLEDのダイナミック点灯用（桁選択）
- **PB0～PB7**: 7セグメントLEDのセグメント制御用（A, B, G, F, E, C, D, 小数点）
- **PA0 (SDA), PA1 (SCL)**: AHT25センサーとのI2C通信用
- **PD6**: モード切り替えおよびリセット用のスイッチ入力（外部プルアップ抵抗を使用）

この構成により、ATtiny2313の限られたピンを効率的に活用しつつ、機能を実現しています。

---

## 機能詳細

### 1. 温度と湿度の測定

- **センサー**: AHT25（I2Cインターフェース）
- **取得頻度**: 約330ms間隔（1msごとにタイマーカウンタを増やし、250回でセンサー値を読み取り、80ms待機）
- **計算**:
  - 温度: -9.9℃～99.9℃（10倍値で管理、例: -8.3℃ → -83）※AHT25は-40～80までになっている。
  - 湿度: 0～99.9%（10倍値で管理、例: 45.6% → 456）

### 2. 7セグメントLED表示

- **ダイナミック点灯**: 6桁の7セグメントLEDを使用
  - タイマー0の比較一致割り込みで1ms間隔（1kHz）に桁を切り替え
  - 更新レート: 約166Hz（1フレーム6ms = 1ms × 6桁）
- **表示内容**:
  - 右3桁: 湿度（例: "45.6"）
  - 左3桁: 温度（例: "23.5" または "-8.3"）
  - 小数点: 湿度と温度の2桁目と3桁目の間に表示

### 3. 表示モードの切り替え

- **スイッチ操作**: PD6に接続されたスイッチを使用
  - **短押し**（4秒未満）: 最高値（1秒表示）→最低値（1秒表示）→通常表示の順に切り替え
    - 通常モード: 現在の温度と湿度を表示
    - 最高値モード: これまでに記録した最大の温度と湿度を表示
    - 最低値モード: これまでに記録した最小の温度と湿度を表示
  - **長押し**（約4秒以上）: 最高値と最低値をリセット
    - リセット後、「8.8.8.8.8.8.」を1秒間表示
    - 初期値: 温度（最高-50.0℃、最低150.0℃）、湿度（最高0.0%、最低100.0%）

### 4. セグメント制御

- **表示パターン**: 0～9、マイナス記号（`-`）、空白をサポート
  - 負の温度対応: -9.9℃まで「-X.X」形式で表示
  - ビット配置: `ABGF ECDd`（負論理、0で点灯）
- **エラー表示**: センサー通信失敗時に、ダッシュ（`-`）が左右に動くアニメーションを表示

---

## ハードウェア構成

- **マイコン**: ATtiny2313A（クロック1MHz）
- **センサー**: AHT25（I2C接続、PA0=SDA、PA1=SCL）
- **表示**: 6桁7セグメントLED（ダイナミック点灯）
- **スイッチ**: PD6に接続（外部プルアップ抵抗4.7kΩ、内部プルアップも有効）
- **配線**: 最小限のピン使用でシンプル化
- **基板**: 一部がユニバーサル基板になっており、追加のセンサーや回路を実装可能

---

## プログラムの動作

1. **初期化**
   - I2C通信とAHT25センサーを初期化
   - タイマー0を設定し、ダイナミック点灯を開始
   - PD6に内部プルアップを設定
2. **メインループ**
   - 1msごとにスイッチ状態をチェック
   - 約330msごとにセンサー値を読み取り、最高値/最低値を更新
   - 表示モードに応じた値を7セグメントLEDに反映
3. **割り込み**
   - タイマー0の割り込みで1msごとに桁を切り替えて表示を更新

## I2C実装の詳細
ATtiny2313にはハードウェアTWI/I2CモジュールとしてUSI（Universal Serial Interface）機能が搭載されていますが、このプロジェクトではUSI用のポート（PB5～PB7）が7セグメントLEDの制御に使用されているため、PORTAを用いたソフトウェアによるI2C（ビットバンキング）を実装しています。以下は実装の概要です。

- **ピンの割り当て**:
  - **PA0 (SDA)**: I2Cのデータラインとして使用。双方向通信に対応するため、オープンドレイン出力として設定。外部プルアップ抵抗（4.7kΩ推奨）を介してVCCに接続。
  - **PA1 (SCL)**: I2Cのクロックラインとして使用。マイコンがマスターとしてクロック信号を生成するため、出力ピンとして設定。

- **ビットバンキングの仕組み**:
  - I2Cプロトコルのタイミング要件（標準モード、100kHz）を満たすよう、ソフトウェアでピンの状態を制御。
  - SDAおよびSCLの信号は、PORTAのピンの入出力方向と値を直接操作して生成。
  - スタート条件は、SCLがハイの状態でSDAをハイからローへ遷移させることで生成。
  - ストップ条件は、SCLがハイの状態でSDAをローからハイへ遷移させることで生成。
  - データ転送は、SCLがローの間にSDAの状態を変更し、SCLがハイの間にデータを読み書き。
  - ACK/NACKは、スレーブ（AHT25）がSDAを制御することで確認。

- **AHT25との通信**:
  - AHT25のI2Cアドレスは7ビットで`0x38`。
  - 通信は、スタート条件、デバイスアドレス送信、レジスタ指定、データ読み書き、ストップ条件の順で実行。
  - AHT25のデータシートに基づき、初期化コマンド（`0xBA`）や測定開始コマンド（`0xAC`）を送信し、温度・湿度データを6バイトで取得。

- **タイミング制御**:
  - 100kHzのクロック周波数（1クロックあたり約10µs）を実現するために、ATtiny2313のシステムクロック（1MHz）に応じたディレイを挿入。
  - ピンの状態変化は、AHT25のI2Cタイミング要件（セットアップ時間、ホールド時間）を満たすよう調整。

- **ピン選択のメリット**:
  - PORTB（PB0～PB7）を7セグメントLEDのセグメント制御、PORTD（PD0～PD5）をダイナミック点灯の桁選択に使用することで、7セグメントLEDのピンマッピングを簡潔に保ち、制御ロジックを複雑化させないメリットがあります。これにより、PORTAをI2C通信専用に割り当て、USIポートの競合を回避しました。

- **注意点**:
  - プルアップ抵抗の値は、バス容量や通信速度に応じて適切に選定（4.7kΩが一般的）。
  - ノイズ対策として、SCL/SDAラインに適切な配線長やシールドを考慮。
  - ソフトウェア実装のため、割り込み処理や他のタスクとの競合に注意。

この実装により、ATtiny2313の限られたリソースを活用しつつ、AHT25センサーとの安定したI2C通信を実現しています。

---

## 注意点

- **センサー読み取り間隔**: AHT25の仕様上、連続読み取りが可能だが、80msの待機時間を含むため実質330ms間隔
- **表示のちらつき**: 166Hzの更新レートでちらつきはほぼなし
- **スイッチの配線**: 外部プルアップ抵抗（4.7kΩ）と内部プルアップを併用。ボタンはアクティブロー（押すとGNDに接続）
- **I2Cプルアップ**: AHT25に内蔵プルアップがないため、外部プルアップ抵抗（4.7kΩ）を使用
- **センサー取り外し時の動作**: センサーを取り外した場合、ダッシュ（`-`）アニメーションが表示され、最高値/最低値は更新されない

---

## 変更点

- **メモリ最適化**: 初期の2116バイトから`-Os`適用とコード最適化で約2470バイトに削減
- **更新間隔の修正**: 19秒から約330msに短縮（タイマー調整）
- **負の温度対応**: 氷点下の表示エラーを解消し、-9.9℃まで表示可能に
- **表示モードの改良**: 短押しで最高値（1秒）→最低値（1秒）→通常表示に変更
- **長押し時間の調整**: リセットを2秒から4秒に延長

---

## 今後の改良案

- センサー値の表示のばらつきを抑えるため、移動平均を導入する
→（現在のプログラムでもばらつきは発生していない為、導入を見送り中）

---
